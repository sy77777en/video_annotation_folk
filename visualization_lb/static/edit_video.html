<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Edit Video Metadata</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    .container {
      display: flex;
      height: 100vh;
    }
    .sidebar {
      flex: 0 0 calc(100% - 1000px);
      max-width: calc(100% - 1000px);
      overflow-y: auto;
      padding: 20px;
      background: #f4f4f4;
    }
    .preview-panel {
      flex: 0 0 1000px;
      width: 1000px;
      padding: 20px;
      border-left: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: #fff;
    }
    #videoPreview video {
      width: 85%;
      max-height: auto;
      border-radius: 8px;
    }
    #videoMeta {
      margin-top: 20px;
      text-align: center;
    }
    #videoMeta p {
      margin: 6px 0;
    }
    a.edit-link {
      display: none;
      margin-top: 8px;
      padding: 6px 10px;
      background: #28a745;
      color: white;
      text-decoration: none;
      border-radius: 4px;
    }
    a.edit-link:hover {
      background: #218838;
    }
    /* Radio 选项美化 */
    .radio-option {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    .radio-option input[type="radio"] {
      margin: 0;
    }
    .radio-option label {
      margin-left: 8px;
      font-weight: normal;
    }
    /* 通用 Section 样式 */
    .section {
      background: #fff;
      padding: 16px;
      border-radius: 6px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .section h3 {
      margin-top: 0;
      font-size: 1.1rem;
      color: #333;
    }
    .field {
      margin-bottom: 12px;
    }
    .field label {
      font-weight: bold;
      display: block;
      margin-bottom: 4px;
      color: #555;
    }
    button {
      margin-top: 12px;
      padding: 10px 16px;
      font-size: 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      /* width:100%;   ← 删除这行 */
    }
    button:hover {
      background-color: #0056b3;
    }

    /* 新增：按钮们放到同一行 */
    .preview-buttons {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    /* 如果你想要最后一个“返回”按钮自动贴底部，可选 */
    .preview-panel {
      display: flex;
      flex-direction: column;
    }
    /* 让返回按钮推到最底部 */
    .preview-buttons .back-btn {
      margin-left: auto; /* 如果只想最后一个靠右 */
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- 左侧 Sidebar -->
    <div class="sidebar">
      <div id="sections"></div>
    </div>

    <!-- 右侧 预览 & 元信息 & 操作 -->
    <div class="preview-panel">
      <h2>Edit Video Metadata</h2>
      <div id="videoPreview"></div>
      <div id="videoMeta">
        <p><strong>Video Name:</strong> <span id="metaVideoName"></span></p>
        <p><strong>Project Name:</strong> <span id="metaProjectName"></span></p>
        <p><strong>Ground Truth Email:</strong> <span id="metaEmail"></span></p>
<!--        <a id="metaEditLink" target="_blank" class="edit-link">✏️ Open Labelbox Edit Page</a>-->
      </div>
        <div class="preview-buttons">
          <a id="metaEditLink" target="_blank" class="edit-link">✏️ Open Labelbox Edit Page</a>
          <button class="save-btn" onclick="saveJson()">💾 Save Changes</button>
          <button class="back-btn" onclick="history.back()">← Back to List</button>
        </div>
    </div>
  </div>

  <script>
    // --- 硬编码映射 ---
    const optionLabels = {
      color_temperature: {
        warm: "Warm",
        neutral: "Neither warm nor cool",
        cool: "Cool",
        black_white: "N/A (black-white)",
        complex_changing: "Changing",
        complex_contrasting: "Contrast",
        complex_others: "Changing and contrast"
      },
      colorfulness: {
        high_colorfulness: "High colorfulness",
        neutral: "Neither low nor high",
        low_colorfulness: "Low colorfulness",
        black_white: "N/A (black-white)",
        complex_changing: "Changing",
        complex_contrasting: "Contrast",
        complex_others: "Changing and contrast"
      },
      brightness: {
        very_bright: "Overexposed / Very Bright",
        neutral: "Neither too bright nor too dark",
        very_dark: "Underexposed / Very Dark",
        complex_changing: "Changing",
        complex_contrasting: "Contrast",
        complex_others: "Changing and contrast"
      },
      scene_type: {
        interior: "Interior",
        exterior: "Exterior",
        unrealistic_synthetic: "Unrealistic/Synthetic",
        complex_others: "Complex (others)"
      },
      sunlight_level: {
        normal: "Normal",
        sunny: "Hard (sunny)",
        overcast: "Soft (overcast)",
        sunset_sunrise: "Sunset/Sunrise",
        unknown: "N/A (no sunlight)"
      },
      light_quality: {
        hard_light: "Hard Light",
        soft_diffused_light: "Soft / Diffused Light",
        complex_changing: "Complex (changing)",
        complex_contrasting: "Complex (contrasting)",
        complex_others: "Complex (others)"
      },
      subject_contrast_ratio: {
        high_contrast: "High Contrast",
        normal_contrast: "Normal Contrast",
        minimal_contrast: "Minimal Contrast",
        complex: "Complex",
        unknown: "N/A (no subject)"
      },
      sunlight_source:               { true: "Sunlight" },
      moonlight_starlight_source:    { true: "Moonlight / Starlight" },
      firelight_source:              { true: "Firelight" },
      artificial_light_source:       { true: "Artificial Light" },
      non_visible_light_source:      { true: "Non-visible Light Source" },
      abstract_light_source:         { true: "N/A (abstract)" },
      complex_light_source:          { true: "Complex (others)" },
      subject_back_light:            { true: "Back Light" },
      subject_front_light:           { true: "Front Light" },
      subject_top_light:             { true: "Top Light" },
      subject_bottom_light:          { true: "Bottom Light" },
      subject_side_light:            { true: "Side Light" },
      subject_ambient_light:         { true: "Ambient Light" },
      professional_lighting:         { true: "Professional Lighting" },
      rembrandt_lighting:            { true: "Rembrandt Lighting" },
      silhouette:                    { true: "Silhouette" },
      rim_light:                     { true: "Rim Light" },
      lens_flares_regular:           { true: "Lens Flares (Regular)" },
      lens_flares_anamorphic:        { true: "Lens Flares (Anamorphic)" },
      mist_diffusion:                { true: "Mist Diffusion" },
      bokeh:                         { true: "Bokeh" },
      reflection_from_water:         { true: "Reflection from water" },
      reflection_from_glossy_surface:{ true: "Reflection from glossy surface" },
      reflection_from_mirror:        { true: "Reflection from mirror" },
      rainbow:                       { true: "Rainbow" },
      heat_haze:                     { true: "Heat Haze" },
      aurora:                        { true: "Aurora" },
      aerial_perspective:            { true: "Aerial Perspective" },
      lightning:                     { true: "Lightning" },
      colored_neon_lighting:         { true: "Colored/Neon Lighting" },
      headlight_flashlight:          { true: "Headlight/Flashlight" },
      vignette:                      { true: "Vignette" },
      water_caustics:                { true: "Water Caustics" },
      city_light:                    { true: "City Light" },
      street_light:                  { true: "Street Light" },
      volumetric_beam_light:         { true: "Volumetric Beam Light" },
      volumetric_spot_light:         { true: "Volumetric Spot Light" },
      god_rays:                      { true: "God Rays" },
      light_through_medium:          { true: "Light Through Medium" },
      volumetric_light_others:       { true: "Volumetric Light (others)" },
      venetian_blinds:               { true: "Venetian Blinds" },
      subject_shape:                 { true: "Subject Shape" },
      window_frames:                 { true: "Window Frames" },
      foliage:                       { true: "Foliage" },
      shadow_patterns_gobo_others:   { true: "Shadow Patterns/Gobo (others)" },
      color_shifting_smooth:         { true: "Color Shifting (Smooth)" },
      color_shifting_sudden:         { true: "Color Shifting (Sudden)" },
      pulsing_flickering:            { true: "Pulsing / Flickering" },
      flashing:                      { true: "Flashing" },
      moving_light:                  { true: "Moving Light" },
      revealing_shot:                { true: "Revealing Shot" },
      transformation_morphing:       { true: "Transformation / Morphing" },
      levitation_floating:           { true: "Levitation / Floating" },
      explosion:                     { true: "Explosion" },
      shattering_breaking:           { true: "Shattering / Breaking" },
      diffusion:                     { true: "Diffusion" },
      splashing_waves:               { true: "Splashing / Waves" }
    };
    const questionLabels = {
      color_temperature: "The color tones in this video are:",
      colorfulness: "How colorful is this video?",
      brightness: "How bright is the video?",
      scene_type: "Is the scene indoors or outdoors?",
      sunlight_level: "Select the sunlight level",
      light_quality: "What is the light quality across the entire scene?",
      subject_contrast_ratio: "What is the contrast ratio of the light on the main subject?",
      what_is_light_source: "What is the major light source?",
      what_is_major_light_direction: "What is the direction of the major light on the subject?",
      select_special_lighting_effects_on_subject: "Select the type of special lighting effects on the subject:",
      select_special_lens_optical_effects: "Are there any special Lens/Optical effects?",
      are_there_reflection_lights: "Are there any clear Reflection Lights?",
      select_special_natural_lighting_effects: "Select any special natural lighting effects?",
      select_special_lighting_effects_on_scene: "Select the type of special lighting effects on the scene:",
      select_volumetric_light_type: "Select the type of volumetric light (if any):",
      select_shadow_pattern_type: "Select the type of shadow pattern or Gobo lighting:",
      select_lighting_dynamics: "Select the lighting dynamics:",
      are_there_dynamic_effects: "Are there any Dynamic Effects?"
    };
    const RATIO_FIELDS = [
      "color_temperature","colorfulness","brightness","scene_type",
      "subject_contrast_ratio","sunlight_level","light_quality"
    ];
    const CHECKLIST_GROUPS = {
      what_is_light_source: ["sunlight_source","moonlight_starlight_source","firelight_source","artificial_light_source","non_visible_light_source","abstract_light_source","complex_light_source"],
      what_is_major_light_direction: ["subject_back_light","subject_front_light","subject_top_light","subject_bottom_light","subject_side_light","subject_ambient_light"],
      select_special_lighting_effects_on_subject: ["professional_lighting","rembrandt_lighting","silhouette","rim_light"],
      select_special_lens_optical_effects: ["lens_flares_regular","lens_flares_anamorphic","mist_diffusion","bokeh"],
      are_there_reflection_lights: ["reflection_from_water","reflection_from_glossy_surface","reflection_from_mirror"],
      select_special_natural_lighting_effects: ["rainbow","heat_haze","aurora","aerial_perspective","lightning"],
      select_special_lighting_effects_on_scene: ["colored_neon_lighting","headlight_flashlight","vignette","water_caustics","city_light","street_light"],
      select_volumetric_light_type: ["volumetric_beam_light","volumetric_spot_light","god_rays","light_through_medium","volumetric_light_others"],
      select_shadow_pattern_type: ["venetian_blinds","subject_shape","window_frames","foliage","shadow_patterns_gobo_others"],
      select_lighting_dynamics: ["color_shifting_smooth","color_shifting_sudden","pulsing_flickering","flashing","moving_light"],
      are_there_dynamic_effects: ["revealing_shot","transformation_morphing","levitation_floating","explosion","shattering_breaking","diffusion","splashing_waves"]
    };

    const videoName = new URLSearchParams(location.search).get('video_name');
    function getVideoUrl(name) {
      return `https://huggingface.co/datasets/zhiqiulin/video_captioning/resolve/main/${name}`;
    }
    let selectedVideo = null;

    async function loadAndRender() {
      const res = await fetch(`/videos/${encodeURIComponent(videoName)}.json`);
      if (!res.ok) {
        document.getElementById('sections').innerHTML = `<p style="color:red;">加载失败: ${res.status}</p>`;
        return;
      }
      selectedVideo = await res.json();

      // 预览 & 元信息
      document.getElementById('videoPreview').innerHTML =
        `<video src="${getVideoUrl(selectedVideo.video_name)}" controls></video>`;
      const wf = selectedVideo.workflows?.lighting_setup||{};
      document.getElementById('metaVideoName').textContent   = selectedVideo.video_name;
      document.getElementById('metaProjectName').textContent = wf.project_name||'unknown';
      document.getElementById('metaEmail').textContent       =
        ({ 'lightingtest-0':'zhiqiulin98@gmail.com','lightingtest-1':'zhiqiulin98@gmail.com',
           'lightingtest2-0':'zhiqiulin98@gmail.com','lightingtest2-2':'zhiqiulin98@gmail.com',
           'lightingtest-2':'ttiffanyyllingg@gmail.com','lightingtest2-1':'ttiffanyyllingg@gmail.com',
           'lightingtest2-3':'ttiffanyyllingg@gmail.com','lightingtest2-4':'ttiffanyyllingg@gmail.com'
         })[wf.project_name]||'unknown';
      const link = document.getElementById('metaEditLink');
      if (wf.editing_url) {
        link.href = wf.editing_url;
        link.style.display = 'inline-block';
      }

      // 渲染表单
      const out = document.getElementById('sections');
      out.innerHTML = '';

      // 单选 (Ratio)
      RATIO_FIELDS.forEach(f => {
        const section = document.createElement('div');
        section.className = 'section';
        section.innerHTML = `<h3>${questionLabels[f]}</h3>`;
        Object.entries(optionLabels[f]).forEach(([val, txt]) => {
          const row = document.createElement('div');
          row.className = 'radio-option';
          const rb = document.createElement('input');
          rb.type = 'radio'; rb.name = f; rb.value = val;
          rb.id = `${f}__${val}`;
          if (selectedVideo.lighting_setup[f] === val) rb.checked = true;
          rb.onchange = () => selectedVideo.lighting_setup[f] = val;
          const lbl = document.createElement('label');
          lbl.htmlFor = rb.id; lbl.textContent = txt;
          row.append(rb, lbl);
          section.appendChild(row);
        });
        out.appendChild(section);
      });

      // 复选 (Checklist)
      Object.entries(CHECKLIST_GROUPS).forEach(([qName, keys]) => {
        const section = document.createElement('div');
        section.className = 'section';
        section.innerHTML = `<h3>${questionLabels[qName]}</h3>`;
        keys.forEach(key => {
          const fld = document.createElement('div');
          fld.className = 'field';
          const cb = document.createElement('input');
          cb.type = 'checkbox'; cb.checked = !!selectedVideo.lighting_setup[key];
          cb.onchange = () => selectedVideo.lighting_setup[key] = cb.checked;
          const text = optionLabels[key]?.true || key.replace(/_/g,' ');
          const lb = document.createElement('label');
          lb.append(cb, document.createTextNode(' ' + text));
          fld.appendChild(lb);
          section.appendChild(fld);
        });
        out.appendChild(section);
      });
    }

    async function saveJson() {
      const r = await fetch(`/videos/${encodeURIComponent(videoName)}.json`, {
        method:'PUT',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(selectedVideo,null,4)
      });
      if (r.ok) alert('✔️ 保存成功！');
      else {
        const t = await r.text();
        alert('❌ 保存失败：'+r.status+' '+t);
      }
    }

    loadAndRender();
  </script>
</body>
</html>
